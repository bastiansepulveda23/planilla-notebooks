<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planilla de Registro ABG</title>

<!-- Estilos -->
<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#1e3a8a;color:#fff;padding:15px}
header h1{margin:0;font-size:22px}
.container{max-width:900px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
input,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #aaa}
button{background:#1e3a8a;color:#fff;border:none}
.estado{font-weight:bold}
.disponible{color:green}
.prestado{color:red}
.admin-only{display:none}
#qr-reader{width:100%}
</style>

<!-- EscÃ¡ner QR compatible mÃ³vil -->
<script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body>

<header>
<h1>ðŸ“˜ Planilla de Registro ABG</h1>
</header>

<div class="container">

<!-- MODO ADMIN -->
<div class="card">
<h2>Modo Administrador</h2>
<input type="password" id="adminPass" placeholder="ContraseÃ±a">
<button onclick="activarAdmin()">Entrar</button>
<p id="adminEstado"></p>
</div>

<!-- REGISTRO -->
<div class="card">
<h2>Registrar PrÃ©stamo</h2>

<label>Estudiante (Nombre + Curso)</label>
<input id="estudiante">

<label>Docente a cargo</label>
<input id="docente">

<label>CÃ³digo de equipo</label>
<input id="equipo">

<button onclick="registrar()">Registrar prÃ©stamo</button>
<button onclick="scanEquipo()">ðŸ“· Escanear QR Equipo</button>
<button onclick="scanEstudiante()">ðŸ“· Escanear QR Estudiante</button>

<div id="qr-reader"></div>
<p id="estadoEquipo" class="estado"></p>
</div>

<!-- HISTORIAL -->
<div class="card admin-only">
<h2>Historial de prÃ©stamos</h2>
<ul id="historial"></ul>
</div>

<!-- BACKUP -->
<div class="card admin-only">
<h2>Backup</h2>
<button onclick="exportar()">Exportar backup</button>
<input type="file" onchange="importar(this)">
</div>

</div>

<script>
// --------------------
// DATOS
// --------------------
let prestamos = JSON.parse(localStorage.getItem("prestamos") || "[]");
let scanner;

// --------------------
// ADMIN
// --------------------
function activarAdmin(){
 if(adminPass.value==="1234"){
   document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
   adminEstado.innerText="Modo administrador activo";
 } else alert("ContraseÃ±a incorrecta");
}

// --------------------
// REGISTRAR
// --------------------
function registrar(){
 const e=estudiante.value.trim();
 const d=docente.value.trim();
 const eq=equipo.value.trim();
 if(!e||!d||!eq){alert("Faltan datos");return;}

 if(prestamos.find(p=>p.eq===eq && !p.devuelto)){
   estadoEquipo.innerHTML="ðŸ”´ Equipo actualmente prestado";
   estadoEquipo.className="estado prestado";
   return;
 }

 prestamos.push({
   e,d,eq,
   fechaPrestamo:new Date().toLocaleString(),
   devuelto:false
 });
 guardar();
 estadoEquipo.innerHTML="ðŸŸ¢ PrÃ©stamo registrado";
 estadoEquipo.className="estado disponible";
 equipo.value="";
 mostrarHistorial();
}

// --------------------
// DEVOLVER
// --------------------
function devolver(i){
 prestamos[i].devuelto=true;
 prestamos[i].fechaDevolucion=new Date().toLocaleString();
 guardar();
 mostrarHistorial();
}

// --------------------
// HISTORIAL
// --------------------
function mostrarHistorial(){
 historial.innerHTML="";
 prestamos.forEach((p,i)=>{
   const li=document.createElement("li");
   li.innerHTML=`
   ${p.fechaPrestamo} â€” ${p.e} â€” Equipo ${p.eq}
   ${p.devuelto?"ðŸŸ¢ Devuelto":"ðŸ”´ Prestado"}
   ${!p.devuelto?`<button onclick="devolver(${i})">Devolver</button>`:""}
   `;
   historial.appendChild(li);
 });
}

// --------------------
// BACKUP
// --------------------
function guardar(){
 localStorage.setItem("prestamos",JSON.stringify(prestamos));
}
function exportar(){
 const b=new Blob([JSON.stringify(prestamos,null,2)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(b);
 a.download="backup_abg.json";
 a.click();
}
function importar(i){
 const r=new FileReader();
 r.onload=()=>{prestamos=JSON.parse(r.result);guardar();mostrarHistorial();};
 r.readAsText(i.files[0]);
}

// --------------------
// ESCÃNER QR
// --------------------
function iniciarScanner(cb){
 if(scanner) scanner.stop();
 scanner=new Html5Qrcode("qr-reader");
 Html5Qrcode.getCameras().then(c=>{
   scanner.start(c[0].id,{fps:10,qrbox:250},
   t=>{cb(t);scanner.stop();},
   ()=>{}
   );
 });
}
function scanEquipo(){ iniciarScanner(t=>equipo.value=t); }
function scanEstudiante(){ iniciarScanner(t=>estudiante.value=t); }

mostrarHistorial();
</script>

</body>
</html>